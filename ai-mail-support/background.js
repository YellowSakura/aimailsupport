(()=>{var e;class t{mainUserLanguageCode;servicesTimeout;temperature;PROMPTS={ANALYZE_INTENT:"You are an assistant that analyzes the tone and perceived intent of an email and provides the analysis in %language%; describe how the email might come across to the recipient, considering tone, clarity, potential emotional impact, and coherence with the context of the email thread history; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",EXPLAIN:"You are an assistant that explains the content of emails in %language% in a clear and simple way, preserving the original meaning; avoid unnecessary complexity; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",REPHRASE:"You are an assistant that rephrases the content of emails in %language% using a %toneOfVoice% tone of voice; preserve the original meaning; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",SUGGEST_IMPROVEMENTS:"You are an assistant that suggests improvements to the content of emails in %language%, focusing on clarity, tone, and effectiveness; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",SUGGEST_REPLY:"You are an assistant that suggests a reply to the email in %language%, using a %toneOfVoice% tone of voice; ensure the reply is clear and relevant to the sender’s message; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",SUMMARIZE:"You are an assistant that summarizes emails in %language% in a short and clear way, focusing only on the sender’s core message or request; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",TRANSLATE:"You are an assistant that translates emails into %language% as naturally and accurately as possible; preserve meaning, tone, and style; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters"};constructor(e){this.mainUserLanguageCode=e.mainUserLanguageCode,this.servicesTimeout=e.servicesTimeout,this.temperature=e.temperature}async analyzeTextIntent(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async applyCustomPrompt(e,t){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async explainText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async getSpeechFromText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async moderateText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async rephraseText(e,t){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async suggestImprovementsForText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async suggestReplyFromText(e,t){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async summarizeText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async testIntegration(){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async translateText(e,t=null){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}canAnalyzeTextIntent(){return this.analyzeTextIntent!==t.prototype.analyzeTextIntent}canApplyCustomPrompt(){return this.applyCustomPrompt!==t.prototype.applyCustomPrompt}canExplainText(){return this.explainText!==t.prototype.explainText}canModerateText(){return this.moderateText!==t.prototype.moderateText}canRephraseText(){return this.rephraseText!==t.prototype.rephraseText}canSpeechFromText(){return this.getSpeechFromText!==t.prototype.getSpeechFromText}canSuggestImprovementsForText(){return this.suggestImprovementsForText!==t.prototype.suggestImprovementsForText}canSuggestReply(){return this.suggestReplyFromText!==t.prototype.suggestReplyFromText}canSummarizeText(){return this.summarizeText!==t.prototype.summarizeText}canTranslateText(){return this.translateText!==t.prototype.translateText}createAbortSignalWithTimeout(e){let t=new AbortController,a=setTimeout(()=>t.abort(),1e3*e);return{signal:t.signal,clearAbortSignalWithTimeout:function(){clearTimeout(a)}}}}let a=((e={}).CREDIT_CARD="CREDIT_CARD",e.CRYPTO="CRYPTO",e.DATE_TIME="DATE_TIME",e.EMAIL_ADDRESS="EMAIL_ADDRESS",e.IBAN_CODE="IBAN_CODE",e.IP_ADDRESS="IP_ADDRESS",e.PHONE_NUMBER="PHONE_NUMBER",e.URL="URL",e.CVV="CVV",e.BIC_SWIFT="BIC_SWIFT",e.US_BANK_NUMBER="US_BANK_NUMBER",e.US_DRIVER_LICENSE="US_DRIVER_LICENSE",e.US_ITIN="US_ITIN",e.US_PASSPORT="US_PASSPORT",e.US_SSN="US_SSN",e.UK_NHS="UK_NHS",e.UK_NINO="UK_NINO",e.ES_NIF="ES_NIF",e.ES_NIE="ES_NIE",e.IT_FISCAL_CODE="IT_FISCAL_CODE",e.IT_DOCUMENT="IT_DOCUMENT",e.IT_VAT_CODE="IT_VAT_CODE",e.PL_PESEL="PL_PESEL",e.FI_PERSONAL_IDENTITY_CODE="FI_PERSONAL_IDENTITY_CODE",e.SG_NRIC_FIN="SG_NRIC_FIN",e.SG_UEN="SG_UEN",e.AU_ABN="AU_ABN",e.AU_ACN="AU_ACN",e.AU_TFN="AU_TFN",e.AU_MEDICARE="AU_MEDICARE",e.IN_PAN="IN_PAN",e.IN_AADHAAR="IN_AADHAAR",e.IN_VEHICLE_REGISTRATION="IN_VEHICLE_REGISTRATION",e.IN_VOTER="IN_VOTER",e.IN_PASSPORT="IN_PASSPORT",e.KR_RRN="KR_RRN",e),s=RegExp("(?:(?:[sS][wW][iI][fF][tT])|(?:[bB][iI][cC])|(?:[bB][aA][nN][kK][\\s-]?[cC][oO][dD][eE])|(?:[sS][wW][iI][fF][tT][\\s-]?[cC][oO][dD][eE])|(?:[bB][iI][cC][\\s-]?[cC][oO][dD][eE]))[:\\s=]+([A-Z]{4}[A-Z]{2}[A-Z0-9]{2}(?:[A-Z0-9]{3})?)\\b","g"),n={[a.CREDIT_CARD]:[/\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b/g],[a.CRYPTO]:[/\b[13][a-km-zA-HJ-NP-Z1-9]{25,34}\b/g],[a.DATE_TIME]:[/\b(0[1-9]|1[0-2])[/-](0[1-9]|[12]\d|3[01])[/-](19|20)\d{2}\b/g],[a.EMAIL_ADDRESS]:[/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g,RegExp("(?<=[?&=/])[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}","g")],[a.IBAN_CODE]:[/\b[A-Z]{2}[0-9]{2}[A-Z0-9]{4}[0-9]{7}([A-Z0-9]?){0,16}\b/g],[a.IP_ADDRESS]:[/\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b/g,/\b(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}\b/g,/\b(?:[0-9a-fA-F]{1,4}:){1,7}:|:(?::[0-9a-fA-F]{1,4}){1,7}\b/g],[a.PHONE_NUMBER]:[/\b(\+\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g],[a.URL]:[/\bhttps?:\/\/(?:[-\w.])+(?::[0-9]+)?(?:\/(?:[\w/_.])*(?:\?(?:[\w&=%.])*)?(?:#(?:[\w.])*)?)?/g],[a.CVV]:[/\b(?:cvv|cvc|security\s*code|card\s*code)[\s:=]*[0-9]{3,4}\b/gi],[a.BIC_SWIFT]:[s],[a.US_BANK_NUMBER]:[/\b\d{8,17}\b/g],[a.US_DRIVER_LICENSE]:[/\b[A-Z]\d{7}\b/g],[a.US_ITIN]:[/\b9\d{2}-\d{2}-\d{4}\b/g],[a.US_PASSPORT]:[/\b[A-Z]\d{8}\b/g],[a.US_SSN]:[/\b\d{3}-\d{2}-\d{4}\b|\b\d{9}\b/g],[a.UK_NHS]:[/\b\d{3} \d{3} \d{4}\b/g],[a.UK_NINO]:[/\b[A-Z]{2}\d{6}[A-Z]\b/g],[a.ES_NIF]:[/\b\d{8}[A-Z]\b/g],[a.ES_NIE]:[/\b[XYZ]\d{7}[A-Z]\b/g],[a.IT_FISCAL_CODE]:[/\b[A-Z]{6}\d{2}[A-Z]\d{2}[A-Z]\d{3}[A-Z]\b/g],[a.IT_DOCUMENT]:[/\b[A-Z]{2}\d{7}\b/g],[a.IT_VAT_CODE]:[/\bIT\d{11}\b/g],[a.PL_PESEL]:[/\b\d{11}\b/g],[a.FI_PERSONAL_IDENTITY_CODE]:[/\b\d{6}[+-A]\d{3}[A-Z0-9]\b/g],[a.SG_NRIC_FIN]:[/\b[A-Z]\d{7}[A-Z]\b/g],[a.SG_UEN]:[/\b\d{8}[A-Z]\b|\b\d{9}[A-Z]\b/g],[a.AU_ABN]:[/\b\d{2} \d{3} \d{3} \d{3}\b/g],[a.AU_ACN]:[/\b\d{3} \d{3} \d{3}\b/g],[a.AU_TFN]:[/\b\d{9}\b/g],[a.AU_MEDICARE]:[/\b\d{4} \d{5} \d{1}\b/g],[a.IN_PAN]:[/\b[A-Z]{5}\d{4}[A-Z]\b/g],[a.IN_AADHAAR]:[/\b\d{4} \d{4} \d{4}\b/g],[a.IN_VEHICLE_REGISTRATION]:[/\b[A-Z]{2}\d{2}[A-Z]{2}\d{4}\b/g],[a.IN_VOTER]:[/\b[A-Z]{3}\d{7}\b/g],[a.IN_PASSPORT]:[/\b[A-Z]\d{7}\b/g],[a.KR_RRN]:[/\b\d{2}(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])-[1-4]\d{6}\b/g]};function r(e,t=Object.values(a)){if(!e)return e;for(let a of t){let t=n[a];if(t&&t.length)for(let s of t)e=e.replace(s,`<${a}>`)}return e}async function i(e){let t=null;try{t=(await browser.storage.sync.get(e))[e]}catch(t){l(`An error occurred while retrieving the config for ${e}: ${t}`,"error")}return t}async function o(){let e=null;try{e=await browser.storage.sync.get(null)}catch(e){l(`An error occurred while retrieving configs: ${e}`,"error")}return e}async function g(){let e=await messenger.tabs.query({active:!0,currentWindow:!0}),t=await messenger.messageDisplay.getDisplayedMessage(e[0].id),a=t?null:await messenger.compose.getComposeDetails(e[0].id),s=null,n=null;if(t)for(let e of(await messenger.messages.listInlineTextParts(t.id)))e.contentType?.toLowerCase()==="text/html"?s=e.content:e.contentType?.toLowerCase()==="text/plain"&&(n=e.content);else a&&(s=a.body,n=a.plainTextBody);return null==n&&s&&(n=await messenger.messengerUtilities.convertToPlainText(s)),n&&(n=n.replace(/https?:\/\/[^\s]+/g,"").replace(/[\r\n]+/g," ").replace(/\s{2,}/g," ").trim(),!0===await i("maskPii")&&(l("Masking PII...","debug"),n=function(e){let{customRules:t=[],fixedPiiEntities:a=[]}={},s=function(e){if(!e)return e;let t=/(?:\u200B|\u200C|\u200D|\u2060|\uFEFF)/g;try{return e.normalize("NFKC").replace(t,"")}catch{return e.replace(t,"")}}(e);return t.length>0&&(s=function(e,t){if(!e||!t||0===t.length)return e;for(let a of t)a.pattern&&void 0!==a.replacement&&(e=e.replace(a.pattern,`<${a.replacement}>`));return e}(s,t)),a.length>0?r(s,a):r(s)}(n))),n||null}async function u(){let e=await messenger.tabs.query({active:!0,currentWindow:!0});try{return!!await messenger.compose.getComposeDetails(e[0].id)}catch(e){return!1}}function m(e,t="en"){let a=new Intl.DisplayNames([t],{type:"language"});try{return a.of(e)}catch(e){l(`Error in retrieving the language name from the code: ${e}`,"error");return}}async function l(e,t="log"){!0===await i("debugMode")&&console[t](`AI Mail Support: ${e}`)}async function c(e){let t=await browser.tabs.query({active:!0,currentWindow:!0});await browser.tabs.sendMessage(t[0].id,e)}let p={anthropic:class extends t{apiKey;model;constructor(e){super(e),this.temperature=e.temperature/2,this.apiKey=e.anthropic.apiKey,this.model=e.anthropic.model}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE,e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}getHeaders(){let e=new Headers;return e.append("x-api-key",this.apiKey),e.append("anthropic-version","2023-06-01"),e.append("anthropic-dangerous-direct-browser-access","true"),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,temperature:this.temperature,max_tokens:2048,system:e,messages:[{role:"user",content:t}]}),r={method:"POST",headers:this.getHeaders(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.anthropic.com/v1/messages",r);if(s(),!i.ok){let e=await i.json();throw Error(`Anthropic error: ${e.error.message}`)}return(await i.json()).content[0].text}},deepseek:class extends t{apiKey;constructor(e){super(e),this.apiKey=e.deepseek.apiKey}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE,e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}getHeaders(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeaders(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.deepseek.com/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`DeepSeek error: ${e.error.message}`)}return(await i.json()).choices[0].message.content}},google:class extends t{apiKey;model;constructor(e){super(e),this.apiKey=e.google.apiKey,this.model=e.google.model}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE,e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}getHeaders(){let e=new Headers;return e.append("Content-Type","application/json"),e.append("x-goog-api-key",this.apiKey),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({system_instruction:{parts:{text:e}},contents:{parts:{text:t}},safety_settings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}],generationConfig:{temperature:this.temperature}}),r={method:"POST",headers:this.getHeaders(),body:n,redirect:"follow",signal:a},i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent`,r);if(s(),!i.ok){let e=await i.json();throw Error(`Google AI error: ${e.error.message}`)}let o=await i.json();if("SAFETY"==o.candidates[0].finishReason)throw Error(`Google AI error: ${browser.i18n.getMessage("errorGoogleGeminiSafetyThresholdExceeded")}`);return o.candidates[0].content.parts[0].text}},groq:class extends t{apiKey;model;constructor(e){super(e),this.apiKey=e.groq.apiKey,this.model=e.groq.model}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}static async getModels(e){let t={method:"GET",redirect:"follow",headers:new Headers({Authorization:`Bearer ${e}`})},a=await fetch("https://api.groq.com/openai/v1/models",t);if(!a.ok){let e=await a.json();throw Error(`Groq error: ${e.error.message}`)}return(await a.json()).data.map(e=>e.id)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize in ${m(this.mainUserLanguageCode)} the text: ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",m(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}getHeaders(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeaders(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.groq.com/openai/v1/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`Groq error: ${e.error.message}`)}return(await i.json()).choices[0].message.content}},lms:class extends t{serviceUrl;model;constructor(e){super(e),this.serviceUrl=e.lms.serviceUrl,this.model=e.lms.model}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}static async getModels(e){let t=await fetch(`${e}/v1/models`,{method:"GET",redirect:"follow"});if(!t.ok){let e=await t.json();throw Error(`AI Studio error: ${e.error.message}`)}return(await t.json()).data.map(e=>e.id)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize in ${m(this.mainUserLanguageCode)} the text: ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",m(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=new Headers;n.append("Content-Type","application/json");let r=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),i=await fetch(`${this.serviceUrl}/v1/chat/completions`,{method:"POST",headers:n,body:r,redirect:"follow",signal:a});if(s(),!i.ok){let e=await i.json();throw Error(`LM Studio error: ${e.error}`)}return(await i.json()).choices[0].message.content}},mistral:class extends t{apiKey;model;constructor(e){super(e),this.apiKey=e.mistral.apiKey,this.model=e.mistral.model}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize in ${m(this.mainUserLanguageCode)} the text: ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",m(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}getHeaders(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Accept","application/json"),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeaders(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.mistral.ai/v1/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`Mistral AI error: ${e.message??e.detail}`)}return(await i.json()).choices[0].message.content}async moderateText(e){let{signal:t,clearAbortSignalWithTimeout:a}=this.createAbortSignalWithTimeout(this.servicesTimeout),s=JSON.stringify({model:"mistral-moderation-latest",input:e}),n={method:"POST",headers:this.getHeaders(),body:s,redirect:"follow",signal:t},r=await fetch("https://api.mistral.ai/v1/moderations",n);if(a(),!r.ok){let e=await r.json();throw Error(`Mistral AI error: ${e.message??e.detail}`)}let i=await r.json();return this.normalizeModerationResponse(i)}normalizeModerationResponse(e){let t=e.results[0].category_scores,a={};for(let e in t)t.hasOwnProperty(e)&&(a[browser.i18n.getMessage(`mailModerate.mistralClassification.${e}`)]=Math.round(100*t[e]));return a}},ollama:class extends t{serviceUrl;model;constructor(e){super(e),this.serviceUrl=e.ollama.serviceUrl,this.model=e.ollama.model}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}static async getModels(e){let t=await fetch(`${e}/api/tags`,{method:"GET",redirect:"follow"});if(!t.ok){let e=await t.json();throw Error(`Ollama error: ${e.error.message}`)}return(await t.json()).models.map(e=>({name:e.name,model:e.model}))}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize in ${m(this.mainUserLanguageCode)} the text: ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",m(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,system:e,prompt:t,options:{temperature:this.temperature},stream:!1}),r=await fetch(`${this.serviceUrl}/api/generate`,{method:"POST",body:n,redirect:"follow",signal:a});if(s(),!r.ok){let e=await r.json();throw Error(`Ollama error: ${e.error}`)}return(await r.json()).response}},openai:class extends t{apiKey;organizationId;model;text2speechAudioQuality;text2speechVoice;text2speechSpeed;constructor(e){super(e),this.apiKey=e.openai.apiKey,this.organizationId=e.openai.organizationId,this.model=e.openai.model,this.text2speechAudioQuality=e.openai.text2speech.audioQuality,this.text2speechVoice=e.openai.text2speech.voice,this.text2speechSpeed=e.openai.text2speech.speed}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}async getSpeechFromText(e){if(l(`Request for text2speech of the text: ${e}`,"debug"),e.length>4096)throw Error("The text is too long, it exceeds the maximum of 4096 characters");let{signal:t,clearAbortSignalWithTimeout:a}=this.createAbortSignalWithTimeout(this.servicesTimeout),s=JSON.stringify({model:this.text2speechAudioQuality,input:e,voice:this.text2speechVoice,speed:this.text2speechSpeed}),n={method:"POST",headers:this.getHeaders(),body:s,redirect:"follow",signal:t},r=await fetch("https://api.openai.com/v1/audio/speech",n);if(a(),!r.ok){let e=await r.json();throw Error(`OpenAI error: ${e.error.message}`)}return await r.blob()}async moderateText(e){let{signal:t,clearAbortSignalWithTimeout:a}=this.createAbortSignalWithTimeout(this.servicesTimeout),s=JSON.stringify({model:"omni-moderation-latest",input:e}),n={method:"POST",headers:this.getHeaders(),body:s,redirect:"follow",signal:t},r=await fetch("https://api.openai.com/v1/moderations",n);if(a(),!r.ok){let e=await r.json();throw Error(`OpenAI error: ${e.error.message}`)}let i=await r.json();return this.normalizeModerationResponse(i)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize in ${m(this.mainUserLanguageCode)} the text: ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",m(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}getHeaders(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),this.organizationId&&e.append("OpenAI-Organization",this.organizationId),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,input:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeaders(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.openai.com/v1/responses",r);if(s(),!i.ok){let e=await i.json();throw Error(`OpenAI error: ${e.error.message}`)}return(await i.json()).output[0].content[0].text}normalizeModerationResponse(e){let t=e.results[0].category_scores,a={};for(let e in t)t.hasOwnProperty(e)&&(a[browser.i18n.getMessage("mailModerate.openaiClassification."+e.replace(/\//g,"_"))]=Math.round(100*t[e]));return a}},xai:class extends t{apiKey;model;constructor(e){super(e),this.apiKey=e.xai.apiKey,this.model=e.xai.model}async analyzeTextIntent(e){return l(`Request to analyze text intent of ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",m(this.mainUserLanguageCode)),e)}async applyCustomPrompt(e,t){return l(`Applying custom user prompt "${e}" to input text: "${t}"`,"debug"),this.manageMessageContent(e,t)}async explainText(e){return l(`Request to explain in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",m(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return l(`Request to use the tone of voice "${t}" to rephrase in ${m(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return l(`Request suggest improvements in ${m(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",m(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return l(`Request to use the tone of voice "${t}" to suggest a reply in ${m(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",m(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return l(`Request to summarize in ${m(this.mainUserLanguageCode)} the text: ${e} in ${m(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",m(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,l(`Request to translate in ${m(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",m(t)),e)}getHeaders(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeaders(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.x.ai/v1/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`xAI error: ${e.error}`)}return(await i.json()).choices[0].message.content}}};class d{static getInstance(e){return new(p[e.llmProvider]||t)(e)}}let h=null,T=messenger.menus.create({id:"aiAnalyzeIntent",title:browser.i18n.getMessage("mailAnalyzeIntent"),contexts:["compose_action_menu"]}),y=messenger.menus.create({id:"aiExplain",title:browser.i18n.getMessage("mailExplain"),contexts:["compose_action_menu","message_display_action_menu","selection"]}),S=messenger.menus.create({id:"aiSummarize",title:browser.i18n.getMessage("mailSummarize"),contexts:["compose_action_menu","message_display_action_menu","selection"]}),x=messenger.menus.create({id:"aiSubMenuRephrase",title:browser.i18n.getMessage("mailRephrase"),contexts:["selection"]}),R=messenger.menus.create({id:"aiRephraseStandard",title:browser.i18n.getMessage("mailRephrase.standard"),parentId:x,contexts:["selection"]}),C=messenger.menus.create({id:"aiRephraseFluid",title:browser.i18n.getMessage("mailRephrase.fluid"),parentId:x,contexts:["selection"]}),E=messenger.menus.create({id:"aiRephraseCreative",title:browser.i18n.getMessage("mailRephrase.creative"),parentId:x,contexts:["selection"]}),I=messenger.menus.create({id:"aiRephraseSimple",title:browser.i18n.getMessage("mailRephrase.simple"),parentId:x,contexts:["selection"]}),A=messenger.menus.create({id:"aiRephraseFormal",title:browser.i18n.getMessage("mailRephrase.formal"),parentId:x,contexts:["selection"]}),M=messenger.menus.create({id:"aiRephraseAcademic",title:browser.i18n.getMessage("mailRephrase.academic"),parentId:x,contexts:["selection"]}),b=messenger.menus.create({id:"aiRephraseExpanded",title:browser.i18n.getMessage("mailRephrase.expanded"),parentId:x,contexts:["selection"]}),_=messenger.menus.create({id:"aiRephraseShortened",title:browser.i18n.getMessage("mailRephrase.shortened"),parentId:x,contexts:["selection"]}),P=messenger.menus.create({id:"aiRephrasePolite",title:browser.i18n.getMessage("mailRephrase.polite"),parentId:x,contexts:["selection"]}),w=messenger.menus.create({id:"aiSubMenuSuggestReply",title:browser.i18n.getMessage("mailSuggestReply"),contexts:["compose_action_menu"]}),f=messenger.menus.create({id:"aiSuggestReplyStandard",title:browser.i18n.getMessage("mailSuggestReply.standard"),parentId:w,contexts:["compose_action_menu"]}),$=messenger.menus.create({id:"aiSuggestReplyFluid",title:browser.i18n.getMessage("mailSuggestReply.fluid"),parentId:w,contexts:["compose_action_menu"]}),U=messenger.menus.create({id:"aiSuggestReplyCreative",title:browser.i18n.getMessage("mailSuggestReply.creative"),parentId:w,contexts:["compose_action_menu"]}),L=messenger.menus.create({id:"aiSuggestReplySimple",title:browser.i18n.getMessage("mailSuggestReply.simple"),parentId:w,contexts:["compose_action_menu"]}),O=messenger.menus.create({id:"aiSuggestReplyFormal",title:browser.i18n.getMessage("mailSuggestReply.formal"),parentId:w,contexts:["compose_action_menu"]}),N=messenger.menus.create({id:"aiSuggestReplyAcademic",title:browser.i18n.getMessage("mailSuggestReply.academic"),parentId:w,contexts:["compose_action_menu"]}),v=messenger.menus.create({id:"aiSuggestReplyExpanded",title:browser.i18n.getMessage("mailSuggestReply.expanded"),parentId:w,contexts:["compose_action_menu"]}),z=messenger.menus.create({id:"aiSuggestReplyShortened",title:browser.i18n.getMessage("mailSuggestReply.shortened"),parentId:w,contexts:["compose_action_menu"]}),q=messenger.menus.create({id:"aiSuggestReplyPolite",title:browser.i18n.getMessage("mailSuggestReply.polite"),parentId:w,contexts:["compose_action_menu"]}),D=messenger.menus.create({id:"aiSubMenuSummarize",title:browser.i18n.getMessage("mailSummarizeAnd"),contexts:["message_display_action_menu","selection"]}),F=messenger.menus.create({id:"aiSummarizeAndText2Speech",title:browser.i18n.getMessage("mailListen"),parentId:D,contexts:["message_display_action_menu","selection"]}),H=messenger.menus.create({id:"aiText2Speech",title:browser.i18n.getMessage("mailListen"),contexts:["selection"]}),G=messenger.menus.create({id:"aiTranslate",title:browser.i18n.getMessage("mailTranslate"),contexts:["message_display_action_menu","selection"]}),Z=messenger.menus.create({id:"aiSubMenuTranslate",title:browser.i18n.getMessage("mailTranslateAnd"),contexts:["message_display_action_menu","selection"]}),V=messenger.menus.create({id:"aiTranslateAndSummarize",title:browser.i18n.getMessage("mailSummarizeAndAfter"),parentId:Z,contexts:["message_display_action_menu","selection"]}),K=messenger.menus.create({id:"aiTranslateAndText2Speech",title:browser.i18n.getMessage("mailListenAndAfter"),parentId:Z,contexts:["message_display_action_menu","selection"]}),j=messenger.menus.create({id:"aiTranslateSeparator",type:"separator",parentId:Z,contexts:["message_display_action_menu","selection"],visible:!1});X();let Y=messenger.menus.create({id:"aiModerate",title:browser.i18n.getMessage("mailModerate"),contexts:["message_display_action_menu"]}),W=messenger.menus.create({id:"aiSuggestImprovements",title:browser.i18n.getMessage("mailSuggestImprovements"),contexts:["compose_action_menu","message_display_action_menu","selection"]}),B=messenger.menus.create({id:"aiCustomPrompt",title:browser.i18n.getMessage("mailCustomPrompt"),contexts:["compose_action_menu","message_display_action_menu"]});messenger.menus.create({id:"aiMessageDisplayActionMenuSeparator1",type:"separator",contexts:["message_display_action_menu"]});let k=messenger.menus.create({id:"aiOptions",title:browser.i18n.getMessage("options"),contexts:["message_display_action_menu"]});async function J(){let e=await o(),t=d.getInstance(e);messenger.menus.update(T,{enabled:t.canAnalyzeTextIntent()}),messenger.menus.update(B,{enabled:t.canApplyCustomPrompt()}),messenger.menus.update(y,{enabled:t.canExplainText()}),messenger.menus.update(Y,{enabled:t.canModerateText()}),messenger.menus.update(x,{enabled:t.canRephraseText()}),messenger.menus.update(H,{enabled:t.canSpeechFromText()}),messenger.menus.update(F,{enabled:t.canSpeechFromText()}),messenger.menus.update(K,{enabled:t.canSpeechFromText()}),messenger.menus.update(W,{enabled:t.canSuggestImprovementsForText()}),messenger.menus.update(w,{enabled:t.canSuggestReply()}),messenger.menus.update(S,{enabled:t.canSummarizeText()}),messenger.menus.update(D,{enabled:t.canSummarizeText()}),messenger.menus.update(G,{enabled:t.canTranslateText()}),messenger.menus.update(Z,{enabled:t.canTranslateText()})}async function X(){let e=await i("mainUserLanguageCode"),t=await i("translationLanguageCodes");h?.forEach(e=>{messenger.menus.remove(e)}),messenger.menus.update(j,{visible:!1}),t?.length>0&&(h=[],messenger.menus.update(j,{visible:!0}),t.forEach(t=>{let a=m(t,e);if(void 0!==a){let e=`aiTranslateTo_${t}`,s=messenger.menus.create({id:e,title:browser.i18n.getMessage("mailTranslateTo",a),parentId:Z,contexts:["message_display_action_menu","selection"]});h.push(s)}}))}J(),messenger.menus.onClicked.addListener(async e=>{if([k,B].includes(e.menuItemId))return void(e.menuItemId==k?browser.runtime.openOptionsPage():e.menuItemId==B&&c({showPromptDisplay:!0}));let t=await o(),a=d.getInstance(t);c({type:"thinking",content:messenger.i18n.getMessage("thinking")});let s=e.selectionText??await g();if(null==s)return void c({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")});if(c({type:"setComposeMode",isCompose:await u()}),e.menuItemId==T)a.analyzeTextIntent(s).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during intent analysis: ${e.message}`,"error")});else if(e.menuItemId==y)a.explainText(s).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during explanation: ${e.message}`,"error")});else if(e.menuItemId==S)a.summarizeText(s).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during summarization: ${e.message}`,"error")});else if([R,C,E,I,A,M,b,_,P].includes(e.menuItemId)){let t=e.menuItemId.substring(10).toLowerCase();a.rephraseText(s,t).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during rephrasing: ${e.message}`,"error")})}else if([f,$,U,L,O,N,v,z,q].includes(e.menuItemId)){let t=e.menuItemId.substring(14).toLowerCase();a.suggestReplyFromText(s,t).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during reply generation: ${e.message}`,"error")})}else if(e.menuItemId==F)try{let e=await a.summarizeText(s),t=await a.getSpeechFromText(e);c({type:"addAudio",content:t})}catch(e){c({type:"showError",content:e.message}),l(`Error during summarization and text-to-speech: ${e.message}`,"error")}else if(e.menuItemId==H)a.getSpeechFromText(s).then(e=>{c({type:"addAudio",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during text-to-speech conversion: ${e.message}`,"error")});else if(e.menuItemId==G||h?.includes(e.menuItemId)){let t=null,n="aiTranslateTo_";e.menuItemId.startsWith(n)&&(t=e.menuItemId.slice(n.length)),a.translateText(s,t).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during translation: ${e.message}`,"error")})}else if(e.menuItemId==V)try{let e=await a.translateText(s),t=await a.summarizeText(e);c({type:"addText",content:t})}catch(e){c({type:"showError",content:e.message}),l(`Error during translation and summarization: ${e.message}`,"error")}else if(e.menuItemId==K)try{let e=await a.translateText(s),t=await a.getSpeechFromText(e);c({type:"addAudio",content:t})}catch(e){c({type:"showError",content:e.message}),l(`Error during translation and text2Speech: ${e.message}`,"error")}else e.menuItemId==Y?a.moderateText(s).then(e=>{c({type:"addChart",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during moderation: ${e.message}`,"error")}):e.menuItemId==W?a.suggestImprovementsForText(s).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error while improving the text: ${e.message}`,"error")}):["aiOptions"].includes(e.menuItemId)||(c({type:"showError",content:`Invalid menu item selected: ${e.menuItemId}`}),l(`Invalid menu item selected: ${e.menuItemId}`,"error"))}),browser.runtime.onMessage.addListener(async e=>{if("sendUserPromptToBackground"===e.action){let t=await o(),a=d.getInstance(t);c({type:"thinking",content:messenger.i18n.getMessage("thinking")});let s=await g();null==s?c({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")}):a.applyCustomPrompt(e.data.userPrompt,s).then(e=>{c({type:"addText",content:e})}).catch(e=>{c({type:"showError",content:e.message}),l(`Error during the custom prompt: ${e.message}`,"error")})}}),messenger.messageDisplayScripts.register({js:[{file:"/outputDisplay/outputDisplay.js"},{file:"/promptDisplay/promptDisplay.js"}],css:[{file:"/outputDisplay/outputDisplay.css"},{file:"/promptDisplay/promptDisplay.css"}]}),messenger.composeScripts.register({js:[{file:"/outputDisplay/outputDisplay.js"},{file:"/promptDisplay/promptDisplay.js"}],css:[{file:"/outputDisplay/outputDisplay.css"},{file:"/promptDisplay/promptDisplay.css"}]}),browser.runtime.onMessage.addListener(async e=>{"optionsChanged"===e.type&&(J(),X())})})();