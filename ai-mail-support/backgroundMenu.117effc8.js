class e{mainUserLanguageCode;servicesTimeout;PROMPTS={ANALYZE_INTENT:"You are an assistant that analyzes the tone and perceived intent of an email and provides the analysis in %language%; describe how the email might come across to the recipient, considering tone, clarity, potential emotional impact, and coherence with the context of the email thread history; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",EXPLAIN:"You are an assistant that explains the content of emails in %language% in a clear and simple way, preserving the original meaning; avoid unnecessary complexity; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",REPHRASE:"You are an assistant that rephrases the content of emails in %language% using a %toneOfVoice% tone of voice; preserve the original meaning; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",SUGGEST_IMPROVEMENTS:"You are an assistant that suggests improvements to the content of emails in %language%, focusing on clarity, tone, and effectiveness; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",SUGGEST_REPLY:"You are an assistant that suggests a reply to the email in %language%, using a %toneOfVoice% tone of voice; ensure the reply is clear and relevant to the sender’s message; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",SUMMARIZE:"You are an assistant that summarizes emails in %language% in a short and clear way, focusing only on the sender’s core message or request; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters",TRANSLATE:"You are an assistant that translates emails into %language% as naturally and accurately as possible; preserve meaning, tone, and style; Ignore formatting, headers, footers, signatures, quoted replies and unusual characters"};constructor(e){this.mainUserLanguageCode=e.mainUserLanguageCode,this.servicesTimeout=e.servicesTimeout}async analyzeTextIntent(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async explainText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async getSpeechFromText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async moderateText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async rephraseText(e,t){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async suggestImprovementsForText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async suggestReplyFromText(e,t){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async summarizeText(e){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async testIntegration(){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}async translateText(e,t=null){throw Error(browser.i18n.getMessage("errorInvalidAddonOptions"))}getCanAnalyzeTextIntent(){return this.analyzeTextIntent!==e.prototype.analyzeTextIntent}getCanExplainText(){return this.explainText!==e.prototype.explainText}getCanModerateText(){return this.moderateText!==e.prototype.moderateText}getCanRephraseText(){return this.rephraseText!==e.prototype.rephraseText}getCanSpeechFromText(){return this.getSpeechFromText!==e.prototype.getSpeechFromText}getCanSuggestImprovementsForText(){return this.suggestImprovementsForText!==e.prototype.suggestImprovementsForText}getCanSuggestReply(){return this.suggestReplyFromText!==e.prototype.suggestReplyFromText}getCanSummarizeText(){return this.summarizeText!==e.prototype.summarizeText}getCanTranslateText(){return this.translateText!==e.prototype.translateText}createAbortSignalWithTimeout(e){let t=new AbortController,a=setTimeout(()=>t.abort(),1e3*e);return{signal:t.signal,clearAbortSignalWithTimeout:function(){clearTimeout(a)}}}}async function t(e){let t=null;try{t=(await browser.storage.sync.get(e))[e]}catch(t){r(`An error occurred while retrieving the config for ${e}: ${t}`,"error")}return t}async function a(){let e=null;try{e=await browser.storage.sync.get(null)}catch(e){r(`An error occurred while retrieving configs: ${e}`,"error")}return e}async function s(){let e=await messenger.tabs.query({active:!0,currentWindow:!0}),t=await messenger.messageDisplay.getDisplayedMessage(e[0].id),a=t?null:await messenger.compose.getComposeDetails(e[0].id),s=null,n=null;if(t)for(let e of(await messenger.messages.listInlineTextParts(t.id)))e.contentType?.toLowerCase()==="text/html"?s=e.content:e.contentType?.toLowerCase()==="text/plain"&&(n=e.content);else a&&(s=a.body,n=a.plainTextBody);return null==n&&s&&(n=await messenger.messengerUtilities.convertToPlainText(s)),n&&(n=n.replace(/https?:\/\/[^\s]+/g,"").replace(/[\r\n]+/g," ").replace(/\s{2,}/g," ").trim()),n||null}function n(e,t="en"){let a=new Intl.DisplayNames([t],{type:"language"});try{return a.of(e)}catch(e){r(`Error in retrieving the language name from the code: ${e}`,"error");return}}async function r(e,a="log"){!0===await t("debugMode")&&console[a](`AI Mail Support: ${e}`)}async function i(e){let t=await browser.tabs.query({active:!0,currentWindow:!0});await browser.tabs.sendMessage(t[0].id,e)}const o={anthropic:class extends e{temperature;apiKey;model;constructor(e){super(e),this.temperature=e.temperature/2,this.apiKey=e.anthropic.apiKey,this.model=e.anthropic.model}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE,e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}getHeader(){let e=new Headers;return e.append("x-api-key",this.apiKey),e.append("anthropic-version","2023-06-01"),e.append("anthropic-dangerous-direct-browser-access","true"),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,temperature:this.temperature,max_tokens:2048,system:e,messages:[{role:"user",content:t}]}),r={method:"POST",headers:this.getHeader(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.anthropic.com/v1/messages",r);if(s(),!i.ok){let e=await i.json();throw Error(`Anthropic error: ${e.error.message}`)}return(await i.json()).content[0].text}},deepseek:class extends e{temperature;apiKey;constructor(e){super(e),this.apiKey=e.deepseek.apiKey}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE,e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}getHeader(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:"deepseek-chat",messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeader(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.deepseek.com/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`DeepSeek error: ${e.error.message}`)}return(await i.json()).choices[0].message.content}},google:class extends e{temperature;apiKey;model;constructor(e){super(e),this.temperature=e.temperature,this.apiKey=e.google.apiKey,this.model=e.google.model}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE,e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}getHeader(){let e=new Headers;return e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({system_instruction:{parts:{text:e}},contents:{parts:{text:t}},safety_settings:[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_NONE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_NONE"}],generationConfig:{temperature:this.temperature}}),r={method:"POST",headers:this.getHeader(),body:n,redirect:"follow",signal:a},i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${this.model}:generateContent?key=${this.apiKey}`,r);if(s(),!i.ok){let e=await i.json();throw Error(`Google AI error: ${e.error.message}`)}let o=await i.json();if("SAFETY"==o.candidates[0].finishReason)throw Error(`Google AI error: ${browser.i18n.getMessage("errorGoogleGeminiSafetyThresholdExceeded")}`);return o.candidates[0].content.parts[0].text}},groq:class extends e{temperature;apiKey;model;constructor(e){super(e),this.temperature=e.temperature,this.apiKey=e.groq.apiKey,this.model=e.groq.model}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}static async getModels(e){let t={method:"GET",redirect:"follow",headers:new Headers({Authorization:`Bearer ${e}`})},a=await fetch("https://api.groq.com/openai/v1/models",t);if(!a.ok){let e=await a.json();throw Error(`Groq error: ${e.error.message}`)}return(await a.json()).data.map(e=>e.id)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize in ${n(this.mainUserLanguageCode)} the text: ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",n(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}getHeader(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeader(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.groq.com/openai/v1/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`Groq error: ${e.error.message}`)}return(await i.json()).choices[0].message.content}},lms:class extends e{temperature;serviceUrl;model;constructor(e){super(e),this.temperature=e.temperature,this.serviceUrl=e.lms.serviceUrl,this.model=e.lms.model}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}static async getModels(e){let t=await fetch(`${e}/v1/models`,{method:"GET",redirect:"follow"});if(!t.ok){let e=await t.json();throw Error(`AI Studio error: ${e.error.message}`)}return(await t.json()).data.map(e=>e.id)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize in ${n(this.mainUserLanguageCode)} the text: ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",n(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=new Headers;n.append("Content-Type","application/json");let r=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),i=await fetch(`${this.serviceUrl}/v1/chat/completions`,{method:"POST",headers:n,body:r,redirect:"follow",signal:a});if(s(),!i.ok){let e=await i.json();throw Error(`LM Studio error: ${e.error}`)}return(await i.json()).choices[0].message.content}},mistral:class extends e{temperature;apiKey;constructor(e){super(e),this.apiKey=e.mistral.apiKey}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize in ${n(this.mainUserLanguageCode)} the text: ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",n(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}getHeader(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Accept","application/json"),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:"mistral-large-latest",messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeader(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.mistral.ai/v1/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`Mistral AI error: ${e.message??e.detail}`)}return(await i.json()).choices[0].message.content}async moderateText(e){let{signal:t,clearAbortSignalWithTimeout:a}=this.createAbortSignalWithTimeout(this.servicesTimeout),s=JSON.stringify({model:"mistral-moderation-latest",input:e}),n={method:"POST",headers:this.getHeader(),body:s,redirect:"follow",signal:t},r=await fetch("https://api.mistral.ai/v1/moderations",n);if(a(),!r.ok){let e=await r.json();throw Error(`OpenAI error: ${e.error.message}`)}let i=await r.json();return this.normalizeModerationResponse(i)}normalizeModerationResponse(e){let t=e.results[0].category_scores,a={};for(let e in t)t.hasOwnProperty(e)&&(a[browser.i18n.getMessage(`mailModerate.mistralClassification.${e}`)]=Math.round(100*t[e]));return a}},ollama:class extends e{temperature;serviceUrl;model;constructor(e){super(e),this.temperature=e.temperature,this.serviceUrl=e.ollama.serviceUrl,this.model=e.ollama.model}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}static async getModels(e){let t=await fetch(`${e}/api/tags`,{method:"GET",redirect:"follow"});if(!t.ok){let e=await t.json();throw Error(`Ollama error: ${e.error.message}`)}return(await t.json()).models.map(e=>({name:e.name,model:e.model}))}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize in ${n(this.mainUserLanguageCode)} the text: ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",n(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,system:e,prompt:t,options:{temperature:this.temperature},stream:!1}),r=await fetch(`${this.serviceUrl}/api/generate`,{method:"POST",body:n,redirect:"follow",signal:a});if(s(),!r.ok){let e=await r.json();throw Error(`Ollama error: ${e.error}`)}return(await r.json()).response}},openai:class extends e{temperature;apiKey;organizationId;model;text2speechAudioQuality;text2speechVoice;text2speechSpeed;constructor(e){super(e),this.temperature=e.temperature,this.apiKey=e.openai.apiKey,this.organizationId=e.openai.organizationId,this.model=e.openai.model,this.text2speechAudioQuality=e.openai.text2speech.audioQuality,this.text2speechVoice=e.openai.text2speech.voice,this.text2speechSpeed=e.openai.text2speech.speed}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}async getSpeechFromText(e){if(r(`Request for text2speech of the text: ${e}`,"debug"),e.length>4096)throw Error("The text is too long, it exceeds the maximum of 4096 characters");let{signal:t,clearAbortSignalWithTimeout:a}=this.createAbortSignalWithTimeout(this.servicesTimeout),s=JSON.stringify({model:this.text2speechAudioQuality,input:e,voice:this.text2speechVoice,speed:this.text2speechSpeed}),n={method:"POST",headers:this.getHeader(),body:s,redirect:"follow",signal:t},i=await fetch("https://api.openai.com/v1/audio/speech",n);if(a(),!i.ok){let e=await i.json();throw Error(`OpenAI error: ${e.error.message}`)}return await i.blob()}async moderateText(e){let{signal:t,clearAbortSignalWithTimeout:a}=this.createAbortSignalWithTimeout(this.servicesTimeout),s=JSON.stringify({model:"omni-moderation-latest",input:e}),n={method:"POST",headers:this.getHeader(),body:s,redirect:"follow",signal:t},r=await fetch("https://api.openai.com/v1/moderations",n);if(a(),!r.ok){let e=await r.json();throw Error(`OpenAI error: ${e.error.message}`)}let i=await r.json();return this.normalizeModerationResponse(i)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize in ${n(this.mainUserLanguageCode)} the text: ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",n(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}getHeader(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),this.organizationId&&e.append("OpenAI-Organization",this.organizationId),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeader(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.openai.com/v1/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`OpenAI error: ${e.error.message}`)}return(await i.json()).choices[0].message.content}normalizeModerationResponse(e){let t=e.results[0].category_scores,a={};for(let e in t)t.hasOwnProperty(e)&&(a[browser.i18n.getMessage("mailModerate.openaiClassification."+e.replace(/\//g,"_"))]=Math.round(100*t[e]));return a}},xai:class extends e{temperature;apiKey;model;constructor(e){super(e),this.temperature=e.temperature,this.apiKey=e.xai.apiKey,this.model=e.xai.model}async analyzeTextIntent(e){return r(`Request to analyze text intent of ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.ANALYZE_INTENT.replace("%language%",n(this.mainUserLanguageCode)),e)}async explainText(e){return r(`Request to explain in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.EXPLAIN.replace("%language%",n(this.mainUserLanguageCode)),e)}async rephraseText(e,t){return r(`Request to use the tone of voice "${t}" to rephrase in ${n(this.mainUserLanguageCode)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.REPHRASE.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async suggestImprovementsForText(e){return r(`Request suggest improvements in ${n(this.mainUserLanguageCode)} for the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_IMPROVEMENTS.replace("%language%",n(this.mainUserLanguageCode)),e)}async suggestReplyFromText(e,t){return r(`Request to use the tone of voice "${t}" to suggest a reply in ${n(this.mainUserLanguageCode)} to the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.SUGGEST_REPLY.replace("%language%",n(this.mainUserLanguageCode)).replace("%toneOfVoice%",t),e)}async summarizeText(e){return r(`Request to summarize in ${n(this.mainUserLanguageCode)} the text: ${e} in ${n(this.mainUserLanguageCode)}`,"debug"),this.manageMessageContent(this.PROMPTS.SUMMARIZE.replace("%language%",n(this.mainUserLanguageCode)),e)}async testIntegration(){await this.translateText("Hi!")}async translateText(e,t=null){return t=t??this.mainUserLanguageCode,r(`Request to translate in ${n(t)} the text: ${e}`,"debug"),this.manageMessageContent(this.PROMPTS.TRANSLATE.replace("%language%",n(t)),e)}getHeader(){let e=new Headers;return e.append("Authorization",`Bearer ${this.apiKey}`),e.append("Content-Type","application/json"),e}async manageMessageContent(e,t){let{signal:a,clearAbortSignalWithTimeout:s}=this.createAbortSignalWithTimeout(this.servicesTimeout),n=JSON.stringify({model:this.model,messages:[{role:"system",content:e},{role:"user",content:t}],temperature:this.temperature}),r={method:"POST",headers:this.getHeader(),body:n,redirect:"follow",signal:a},i=await fetch("https://api.x.ai/v1/chat/completions",r);if(s(),!i.ok){let e=await i.json();throw Error(`xAI error: ${e.error}`)}return(await i.json()).choices[0].message.content}}};class g{static getInstance(t){return new(o[t.llmProvider]||e)(t)}}let u=null;const l=messenger.menus.create({id:"aiAnalyzeIntent",title:browser.i18n.getMessage("mailAnalyzeIntent"),contexts:["compose_action_menu"]}),m=messenger.menus.create({id:"aiExplain",title:browser.i18n.getMessage("mailExplain"),contexts:["compose_action_menu","message_display_action_menu","selection"]}),c=messenger.menus.create({id:"aiSummarize",title:browser.i18n.getMessage("mailSummarize"),contexts:["compose_action_menu","message_display_action_menu","selection"]}),h=messenger.menus.create({id:"aiSubMenuRephrase",title:browser.i18n.getMessage("mailRephrase"),contexts:["selection"]}),p=messenger.menus.create({id:"aiRephraseStandard",title:browser.i18n.getMessage("mailRephrase.standard"),parentId:h,contexts:["selection"]}),d=messenger.menus.create({id:"aiRephraseFluid",title:browser.i18n.getMessage("mailRephrase.fluid"),parentId:h,contexts:["selection"]}),T=messenger.menus.create({id:"aiRephraseCreative",title:browser.i18n.getMessage("mailRephrase.creative"),parentId:h,contexts:["selection"]}),y=messenger.menus.create({id:"aiRephraseSimple",title:browser.i18n.getMessage("mailRephrase.simple"),parentId:h,contexts:["selection"]}),x=messenger.menus.create({id:"aiRephraseFormal",title:browser.i18n.getMessage("mailRephrase.formal"),parentId:h,contexts:["selection"]}),M=messenger.menus.create({id:"aiRephraseAcademic",title:browser.i18n.getMessage("mailRephrase.academic"),parentId:h,contexts:["selection"]}),S=messenger.menus.create({id:"aiRephraseExpanded",title:browser.i18n.getMessage("mailRephrase.expanded"),parentId:h,contexts:["selection"]}),R=messenger.menus.create({id:"aiRephraseShortened",title:browser.i18n.getMessage("mailRephrase.shortened"),parentId:h,contexts:["selection"]}),C=messenger.menus.create({id:"aiRephrasePolite",title:browser.i18n.getMessage("mailRephrase.polite"),parentId:h,contexts:["selection"]}),w=messenger.menus.create({id:"aiSubMenuSuggestReply",title:browser.i18n.getMessage("mailSuggestReply"),contexts:["compose_action_menu"]}),E=messenger.menus.create({id:"aiSuggestReplyStandard",title:browser.i18n.getMessage("mailSuggestReply.standard"),parentId:w,contexts:["compose_action_menu"]}),f=messenger.menus.create({id:"aiSuggestReplyFluid",title:browser.i18n.getMessage("mailSuggestReply.fluid"),parentId:w,contexts:["compose_action_menu"]}),$=messenger.menus.create({id:"aiSuggestReplyCreative",title:browser.i18n.getMessage("mailSuggestReply.creative"),parentId:w,contexts:["compose_action_menu"]}),b=messenger.menus.create({id:"aiSuggestReplySimple",title:browser.i18n.getMessage("mailSuggestReply.simple"),parentId:w,contexts:["compose_action_menu"]}),P=messenger.menus.create({id:"aiSuggestReplyFormal",title:browser.i18n.getMessage("mailSuggestReply.formal"),parentId:w,contexts:["compose_action_menu"]}),I=messenger.menus.create({id:"aiSuggestReplyAcademic",title:browser.i18n.getMessage("mailSuggestReply.academic"),parentId:w,contexts:["compose_action_menu"]}),L=messenger.menus.create({id:"aiSuggestReplyExpanded",title:browser.i18n.getMessage("mailSuggestReply.expanded"),parentId:w,contexts:["compose_action_menu"]}),A=messenger.menus.create({id:"aiSuggestReplyShortened",title:browser.i18n.getMessage("mailSuggestReply.shortened"),parentId:w,contexts:["compose_action_menu"]}),U=messenger.menus.create({id:"aiSuggestReplyPolite",title:browser.i18n.getMessage("mailSuggestReply.polite"),parentId:w,contexts:["compose_action_menu"]}),O=messenger.menus.create({id:"aiSubMenuSummarize",title:browser.i18n.getMessage("mailSummarizeAnd"),contexts:["message_display_action_menu","selection"]}),v=messenger.menus.create({id:"aiSummarizeAndText2Speech",title:browser.i18n.getMessage("mailListen"),parentId:O,contexts:["message_display_action_menu","selection"]}),_=messenger.menus.create({id:"aiText2Speech",title:browser.i18n.getMessage("mailListen"),contexts:["selection"]}),N=messenger.menus.create({id:"aiTranslate",title:browser.i18n.getMessage("mailTranslate"),contexts:["message_display_action_menu","selection"]}),q=messenger.menus.create({id:"aiSubMenuTranslate",title:browser.i18n.getMessage("mailTranslateAnd"),contexts:["message_display_action_menu","selection"]}),z=messenger.menus.create({id:"aiTranslateAndSummarize",title:browser.i18n.getMessage("mailSummarizeAndAfter"),parentId:q,contexts:["message_display_action_menu","selection"]}),F=messenger.menus.create({id:"aiTranslateAndText2Speech",title:browser.i18n.getMessage("mailListenAndAfter"),parentId:q,contexts:["message_display_action_menu","selection"]}),G=browser.menus.create({type:"separator",parentId:q,contexts:["message_display_action_menu","selection"],visible:!1});Y();const H=messenger.menus.create({id:"aiModerate",title:browser.i18n.getMessage("mailModerate"),contexts:["message_display_action_menu"]}),k=messenger.menus.create({id:"aiSuggestImprovements",title:browser.i18n.getMessage("mailSuggestImprovements"),contexts:["compose_action_menu","message_display_action_menu","selection"]});browser.menus.create({id:"aiMessageDisplayActionMenuSeparator1",type:"separator",contexts:["message_display_action_menu"]});const j=messenger.menus.create({id:"aiOptions",title:browser.i18n.getMessage("options"),contexts:["message_display_action_menu"]});async function V(){let e=await a(),t=g.getInstance(e);messenger.menus.update(l,{enabled:t.getCanAnalyzeTextIntent()}),messenger.menus.update(m,{enabled:t.getCanExplainText()}),messenger.menus.update(H,{enabled:t.getCanModerateText()}),messenger.menus.update(h,{enabled:t.getCanRephraseText()}),messenger.menus.update(_,{enabled:t.getCanSpeechFromText()}),messenger.menus.update(v,{enabled:t.getCanSpeechFromText()}),messenger.menus.update(F,{enabled:t.getCanSpeechFromText()}),messenger.menus.update(k,{enabled:t.getCanSuggestImprovementsForText()}),messenger.menus.update(w,{enabled:t.getCanSuggestReply()}),messenger.menus.update(c,{enabled:t.getCanSummarizeText()}),messenger.menus.update(O,{enabled:t.getCanSummarizeText()}),messenger.menus.update(N,{enabled:t.getCanTranslateText()}),messenger.menus.update(q,{enabled:t.getCanTranslateText()})}async function Y(){let e=await t("mainUserLanguageCode"),a=await t("translationLanguageCodes");u?.forEach(e=>{messenger.menus.remove(e)}),messenger.menus.update(G,{visible:!1}),a?.length>0&&(u=[],messenger.menus.update(G,{visible:!0}),a.forEach(t=>{let a=n(t,e);if(void 0!==a){let e=`aiTranslateTo_${t}`,s=messenger.menus.create({id:e,title:browser.i18n.getMessage("mailTranslateTo",a),parentId:q,contexts:["message_display_action_menu","selection"]});u.push(s)}}))}V(),messenger.menus.onClicked.addListener(async e=>{let t=await a(),n=g.getInstance(t);if(e.menuItemId==l){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText??await s();null==t?i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")}):n.analyzeTextIntent(t).then(e=>{i({type:"addText",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during intent analysis: ${e.message}`,"error")})}else if(e.menuItemId==m){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();null==t?i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")}):n.explainText(t).then(e=>{i({type:"addText",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during explanation: ${e.message}`,"error")})}else if(e.menuItemId==c){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();null==t?i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")}):n.summarizeText(t).then(e=>{i({type:"addText",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during summarization: ${e.message}`,"error")})}else if([p,d,T,y,x,M,S,R,C].includes(e.menuItemId)){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();if(null==t)i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")});else{let a=e.menuItemId.substring(10).toLowerCase();n.rephraseText(t,a).then(e=>{i({type:"addText",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during rephrasing: ${e.message}`,"error")})}}else if([E,f,$,b,P,I,L,A,U].includes(e.menuItemId)){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();if(null==t)i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")});else{let a=e.menuItemId.substring(14).toLowerCase();n.suggestReplyFromText(t,a).then(e=>{i({type:"addText",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during reply generation: ${e.message}`,"error")})}}else if(e.menuItemId==v){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();if(null==t)i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")});else try{let e=await n.summarizeText(t),a=await n.getSpeechFromText(e);i({type:"addAudio",content:a})}catch(e){i({type:"showError",content:e.message}),r(`Error during summarization and text-to-speech: ${e.message}`,"error")}}else if(e.menuItemId==_){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();null==t?i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")}):n.getSpeechFromText(t).then(e=>{i({type:"addAudio",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during text-to-speech conversion: ${e.message}`,"error")})}else if(e.menuItemId==N||u?.includes(e.menuItemId)){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();if(null==t)i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")});else{let a=null,s="aiTranslateTo_";e.menuItemId.startsWith(s)&&(a=e.menuItemId.slice(s.length)),n.translateText(t,a).then(e=>{i({type:"addText",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during translation: ${e.message}`,"error")})}}else if(e.menuItemId==z){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();if(null==t)i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")});else try{let e=await n.translateText(t),a=await n.summarizeText(e);i({type:"addText",content:a})}catch(e){i({type:"showError",content:e.message}),r(`Error during translation and summarization: ${e.message}`,"error")}}else if(e.menuItemId==F){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let t=e.selectionText?e.selectionText:await s();if(null==t)i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")});else try{let e=await n.translateText(t),a=await n.getSpeechFromText(e);i({type:"addAudio",content:a})}catch(e){i({type:"showError",content:e.message}),r(`Error during translation and text2Speech: ${e.message}`,"error")}}else if(e.menuItemId==H){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let e=await s();null==e?i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")}):n.moderateText(e).then(e=>{i({type:"addChart",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error during moderation: ${e.message}`,"error")})}else if(e.menuItemId==k){i({type:"thinking",content:messenger.i18n.getMessage("thinking")});let e=await s();null==e?i({type:"showError",content:messenger.i18n.getMessage("errorTextNotFound")}):n.suggestImprovementsForText(e).then(e=>{i({type:"addText",content:e})}).catch(e=>{i({type:"showError",content:e.message}),r(`Error while improving the text: ${e.message}`,"error")})}else e.menuItemId==j?browser.runtime.openOptionsPage():["aiOptions"].includes(e.menuItemId)||r(`Invalid menu item selected: ${e.menuItemId}`,"error")}),messenger.messageDisplayScripts.register({js:[{file:"/outputDisplay/outputDisplay.js"},{file:"/promptDisplay/promptDisplay.js"}],css:[{file:"/outputDisplay/outputDisplay.css"},{file:"/promptDisplay/promptDisplay.css"}]}),messenger.composeScripts.register({js:[{file:"/outputDisplay/outputDisplay.js"}],css:[{file:"/outputDisplay/outputDisplay.css"}]}),browser.runtime.onMessage.addListener(async e=>{"optionsChanged"===e.type&&(V(),Y())});